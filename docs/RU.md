# Руководство KeePass cloud syncer

Все команды представленные в данном руководстве выполняются в PowerShell

## Установка

Создайте директорию с произвольным названием в любом месте вашего компьютера,
за исключением системных папок: Windows, Program Files и пр., например:

```powershell
New-Item -Path 'D:\KeePassSyncer' -ItemType Directory
```

Создайте пустой файл скрипта PowerShell с любым названием, например:

```powershell
New-Item -Path 'D:\KeePassSyncer\syncer.ps1' -ItemType File
```

В связи с политиками безопасности Windows, которые усложняют, по понятным причинам,
распространение подобных программ необходимо вручную скопировать содержимое файла
с [исходным кодом](/script.ps1) и вставить файл, созданный на предыдущем этапе.

В процессе своей работы скрипт самостоятельно создаст дополнительный файл
конфигурации `syncer-storage.json`. Данный файл служит хранилищем настроек, а
также содержит авторизационные данные для подключения к облачным провайдерам. 

## Интеграция с KeePass

Для интеграции необходимо в программе KeePass создать триггер и настроить его.

> Путь к файлу скрипта необходимо указать свой 

- Вкладка «Свойства»
  - Название триггера: произвольное
  - Разрешён
  - Включен с момента запуска KeePass
- Вкладка «События»
  - Добавить событие `Сохранён файл базы данных`
  - Поля события оставляем по-умолчанию
- Вкладка «Условия»
  - Ничего не делаем
- Вкладка «Действия»
  - Добавить действие `Выполнить команду/URL`
  - Файл/URL: `powershell`
  - Аргументы: `-File D:\KeePassSyncer\syncer.ps1 {DB_PATH}`
  - Ждать выхода: да
  - Остальные поля оставляем по-умолчанию

Сохраняем триггер и радуемся автоматизации. Каждый раз при сохранении базы KeePass
будет запускаться окно PowerShell с программой синхронизации. 

## Первый запуск

При первом запуске программа в интерактивном режиме предложит провести настройку
используемого облачного провайдера или отключить его. Ниже описаны особенности
каждого провайдера. Ознакомьтесь с ними перед использованием.

### Yandex диск

Для использования даннго провайдера необходимы данные для OAuth авторизации
приложения.

- Client ID
- Client Secret

Для их получения необходимо зарегистрировать свое приложение на Яндекс по
[этой ссылке](https://oauth.yandex.ru/client/new/).

- Платформа: `Веб-сервисы`
- Доступ к данным: `cloud_api:disk.write`

Директория указанная в настройках программы должна быть предварительно создана на
Яндекс диске вручную.

Сохраняемые файлы будут иметь название вида:
```
{filename}_{SHA256HASH}.kdbx
```

Добавление уникального для каждого файла хеша позволяет избежать случайного
перезаписывания файлами с одинаковыми названиями, но находящихся в разных
локальных директориях.

## Последующее использование

Все последующие запуски программы не требуют вмешательства с вашей стороны,
все проиходит автоматически. По завершении программы окно PowerShell закроется
само.

## Проблемы и решения

В процессе эксплуатации могут возникать исключительные ситуации. Программа
будет останавливать свое выполнение и ждать подтверждения со стороны пользователя.
В случае возникновения неразрешимой ситуации попробуйте удалить файл `syncer-storage.json`
и произвести чистую настройку.
